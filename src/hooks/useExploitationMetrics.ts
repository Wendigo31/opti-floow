import { useState, useEffect, useCallback } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useLicenseContext } from '@/context/LicenseContext';
import { toast } from 'sonner';

export interface ExploitationMetricSettings {
  id: string;
  license_id: string;
  
  // Financial metrics visibility for Exploitation role
  can_view_revenue: boolean;
  can_view_margin: boolean;
  can_view_profit: boolean;
  can_view_fuel_cost: boolean;
  can_view_toll_cost: boolean;
  can_view_driver_cost: boolean;
  can_view_structure_cost: boolean;
  can_view_total_cost: boolean;
  can_view_price_per_km: boolean;
  
  // Dashboard visibility
  can_view_dashboard_financials: boolean;
  can_view_forecast: boolean;
  
  created_at: string;
  updated_at: string;
}

const DEFAULT_SETTINGS: Omit<ExploitationMetricSettings, 'id' | 'license_id' | 'created_at' | 'updated_at'> = {
  can_view_revenue: false,
  can_view_margin: true,  // Only margin visible by default
  can_view_profit: false,
  can_view_fuel_cost: false,
  can_view_toll_cost: false,
  can_view_driver_cost: false,
  can_view_structure_cost: false,
  can_view_total_cost: false,
  can_view_price_per_km: false,
  can_view_dashboard_financials: true,
  can_view_forecast: false,
};

// Metric labels for the UI
export const METRIC_LABELS: Record<keyof Omit<ExploitationMetricSettings, 'id' | 'license_id' | 'created_at' | 'updated_at'>, { label: string; description: string; category: string }> = {
  can_view_revenue: {
    label: 'Chiffre d\'affaires',
    description: 'Peut voir le CA des tournées',
    category: 'Tournées',
  },
  can_view_margin: {
    label: 'Marge',
    description: 'Peut voir le pourcentage de marge',
    category: 'Tournées',
  },
  can_view_profit: {
    label: 'Bénéfice',
    description: 'Peut voir le bénéfice net',
    category: 'Tournées',
  },
  can_view_fuel_cost: {
    label: 'Coût carburant',
    description: 'Peut voir le détail du coût carburant',
    category: 'Coûts détaillés',
  },
  can_view_toll_cost: {
    label: 'Coût péages',
    description: 'Peut voir le détail des péages',
    category: 'Coûts détaillés',
  },
  can_view_driver_cost: {
    label: 'Coût conducteur',
    description: 'Peut voir le coût salarial',
    category: 'Coûts détaillés',
  },
  can_view_structure_cost: {
    label: 'Charges de structure',
    description: 'Peut voir les charges fixes réparties',
    category: 'Coûts détaillés',
  },
  can_view_total_cost: {
    label: 'Coût total',
    description: 'Peut voir le coût total d\'une tournée',
    category: 'Coûts détaillés',
  },
  can_view_price_per_km: {
    label: 'Prix au kilomètre',
    description: 'Peut voir le prix €/km',
    category: 'Tournées',
  },
  can_view_dashboard_financials: {
    label: 'Dashboard financier',
    description: 'Accès aux statistiques financières du tableau de bord',
    category: 'Pages',
  },
  can_view_forecast: {
    label: 'Prévisionnel',
    description: 'Accès à la page de prévisions',
    category: 'Pages',
  },
};

interface UseExploitationMetricsReturn {
  settings: ExploitationMetricSettings | null;
  isLoading: boolean;
  isDirection: boolean;
  updateSettings: (updates: Partial<ExploitationMetricSettings>) => Promise<boolean>;
  canExploitationView: (metric: keyof typeof METRIC_LABELS) => boolean;
}

export function useExploitationMetrics(): UseExploitationMetricsReturn {
  const [settings, setSettings] = useState<ExploitationMetricSettings | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const { userRole, licenseId: contextLicenseId, authUserId } = useLicenseContext();
  
  const isDirection = userRole === 'direction';

  // Fetch settings
  useEffect(() => {
    let isMounted = true;
    
    const fetchSettings = async () => {
      if (!authUserId || !contextLicenseId || !isMounted) {
        setIsLoading(false);
        return;
      }

      try {
        // Fetch exploitation metric settings
        const { data, error } = await supabase
          .from('exploitation_metric_settings')
          .select('*')
          .eq('license_id', contextLicenseId)
          .maybeSingle();

        if (error && error.code !== 'PGRST116') {
          console.error('[useExploitationMetrics] Error:', error);
        }

        if (isMounted) {
          if (data) {
            setSettings(data as unknown as ExploitationMetricSettings);
          } else {
            // No settings yet - use defaults
            setSettings(null);
          }
        }
      } catch (err) {
        console.error('[useExploitationMetrics] Error:', err);
      } finally {
        if (isMounted) setIsLoading(false);
      }
    };

    void fetchSettings();
    
    return () => {
      isMounted = false;
    };
  }, [authUserId, contextLicenseId]);

  // Update settings (Direction only)
  const updateSettings = useCallback(async (updates: Partial<ExploitationMetricSettings>): Promise<boolean> => {
    if (!isDirection) {
      toast.error('Seule la Direction peut modifier ces paramètres');
      return false;
    }

    if (!authUserId || !contextLicenseId) return false;

    try {
      if (settings?.id) {
        // Update existing
        const { error } = await supabase
          .from('exploitation_metric_settings')
          .update(updates)
          .eq('id', settings.id);

        if (error) throw error;
        setSettings(prev => prev ? { ...prev, ...updates } : null);
      } else {
        // Create new
        const { data, error } = await supabase
          .from('exploitation_metric_settings')
          .insert({
            license_id: contextLicenseId,
            ...DEFAULT_SETTINGS,
            ...updates,
          })
          .select()
          .single();

        if (error) throw error;
        setSettings(data as unknown as ExploitationMetricSettings);
      }

      toast.success('Paramètres enregistrés');
      return true;
    } catch (err) {
      console.error('[useExploitationMetrics] Update error:', err);
      toast.error('Erreur lors de la sauvegarde');
      return false;
    }
  }, [settings, isDirection, authUserId, contextLicenseId]);

  // Check if exploitation role can view a specific metric
  const canExploitationView = useCallback((metric: keyof typeof METRIC_LABELS): boolean => {
    // Direction can see everything
    if (isDirection) return true;
    
    // No settings = use defaults
    if (!settings) {
      return DEFAULT_SETTINGS[metric] ?? false;
    }
    
    return settings[metric] ?? DEFAULT_SETTINGS[metric] ?? false;
  }, [settings, isDirection]);

  return {
    settings,
    isLoading,
    isDirection,
    updateSettings,
    canExploitationView,
  };
}
