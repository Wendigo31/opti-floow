import { useState } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Switch } from '@/components/ui/switch';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { Settings, Eye, EyeOff, Save, Loader2, ChartBar, Route, DollarSign } from 'lucide-react';
import { useExploitationMetrics, METRIC_LABELS, ExploitationMetricSettings } from '@/hooks/useExploitationMetrics';

interface MetricToggleProps {
  metricKey: keyof typeof METRIC_LABELS;
  value: boolean;
  onChange: (key: keyof typeof METRIC_LABELS, value: boolean) => void;
}

function MetricToggle({ metricKey, value, onChange }: MetricToggleProps) {
  const metric = METRIC_LABELS[metricKey];
  
  return (
    <div className="flex items-center justify-between py-3">
      <div className="space-y-0.5">
        <Label htmlFor={metricKey} className="text-sm font-medium flex items-center gap-2">
          {value ? (
            <Eye className="h-4 w-4 text-green-500" />
          ) : (
            <EyeOff className="h-4 w-4 text-muted-foreground" />
          )}
          {metric.label}
        </Label>
        <p className="text-xs text-muted-foreground">
          {metric.description}
        </p>
      </div>
      <Switch
        id={metricKey}
        checked={value}
        onCheckedChange={(checked) => onChange(metricKey, checked)}
      />
    </div>
  );
}

export function ExploitationMetricsConfig() {
  const { settings, isLoading, isDirection, updateSettings } = useExploitationMetrics();
  const [isSaving, setIsSaving] = useState(false);
  const [localSettings, setLocalSettings] = useState<Partial<ExploitationMetricSettings>>({});
  const [hasChanges, setHasChanges] = useState(false);

  // Get current value for a metric
  const getValue = (key: keyof typeof METRIC_LABELS): boolean => {
    if (key in localSettings) {
      return localSettings[key] as boolean;
    }
    if (settings && key in settings) {
      return settings[key] as boolean;
    }
    // Default values - all pricing modes enabled by default for Exploitation
    const defaults: Record<string, boolean> = {
      can_view_revenue: true,
      can_view_margin: true,
      can_view_profit: true,
      can_view_fuel_cost: true,
      can_view_toll_cost: true,
      can_view_driver_cost: true,
      can_view_structure_cost: false,
      can_view_total_cost: true,
      can_view_price_per_km: true,
      can_view_dashboard_financials: true,
      can_view_forecast: true,
    };
    return defaults[key] ?? false;
  };

  const handleChange = (key: keyof typeof METRIC_LABELS, value: boolean) => {
    setLocalSettings(prev => ({ ...prev, [key]: value }));
    setHasChanges(true);
  };

  const handleSave = async () => {
    if (!hasChanges) return;
    
    setIsSaving(true);
    const success = await updateSettings(localSettings);
    setIsSaving(false);
    
    if (success) {
      setLocalSettings({});
      setHasChanges(false);
    }
  };

  if (!isDirection) {
    return null;
  }

  if (isLoading) {
    return (
      <Card>
        <CardContent className="flex items-center justify-center py-8">
          <Loader2 className="h-6 w-6 animate-spin text-primary" />
        </CardContent>
      </Card>
    );
  }

  // Group metrics by category
  const tourMetrics: (keyof typeof METRIC_LABELS)[] = [
    'can_view_revenue',
    'can_view_margin', 
    'can_view_profit',
    'can_view_price_per_km',
  ];

  const costMetrics: (keyof typeof METRIC_LABELS)[] = [
    'can_view_total_cost',
    'can_view_fuel_cost',
    'can_view_toll_cost',
    'can_view_driver_cost',
    'can_view_structure_cost',
  ];

  const pageMetrics: (keyof typeof METRIC_LABELS)[] = [
    'can_view_dashboard_financials',
    'can_view_forecast',
  ];

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <div>
            <CardTitle className="flex items-center gap-2">
              <Settings className="h-5 w-5" />
              Visibilit√© des m√©triques Exploitation
            </CardTitle>
            <CardDescription>
              Configurez quelles donn√©es financi√®res sont visibles pour les utilisateurs Exploitation
            </CardDescription>
          </div>
          {hasChanges && (
            <Button onClick={handleSave} disabled={isSaving}>
              {isSaving ? (
                <Loader2 className="h-4 w-4 animate-spin mr-2" />
              ) : (
                <Save className="h-4 w-4 mr-2" />
              )}
              Enregistrer
            </Button>
          )}
        </div>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Tour metrics */}
        <div>
          <div className="flex items-center gap-2 mb-3">
            <Route className="h-4 w-4 text-primary" />
            <h3 className="font-medium">Tourn√©es</h3>
            <Badge variant="outline" className="text-xs">
              Visible dans la liste des tourn√©es
            </Badge>
          </div>
          <div className="space-y-1 pl-6 border-l-2 border-muted">
            {tourMetrics.map((key) => (
              <MetricToggle
                key={key}
                metricKey={key}
                value={getValue(key)}
                onChange={handleChange}
              />
            ))}
          </div>
        </div>

        <Separator />

        {/* Cost metrics */}
        <div>
          <div className="flex items-center gap-2 mb-3">
            <DollarSign className="h-4 w-4 text-primary" />
            <h3 className="font-medium">Co√ªts d√©taill√©s</h3>
            <Badge variant="outline" className="text-xs">
              Visible dans le calculateur
            </Badge>
          </div>
          <div className="space-y-1 pl-6 border-l-2 border-muted">
            {costMetrics.map((key) => (
              <MetricToggle
                key={key}
                metricKey={key}
                value={getValue(key)}
                onChange={handleChange}
              />
            ))}
          </div>
        </div>

        <Separator />

        {/* Page access */}
        <div>
          <div className="flex items-center gap-2 mb-3">
            <ChartBar className="h-4 w-4 text-primary" />
            <h3 className="font-medium">Pages</h3>
            <Badge variant="outline" className="text-xs">
              Acc√®s aux fonctionnalit√©s
            </Badge>
          </div>
          <div className="space-y-1 pl-6 border-l-2 border-muted">
            {pageMetrics.map((key) => (
              <MetricToggle
                key={key}
                metricKey={key}
                value={getValue(key)}
                onChange={handleChange}
              />
            ))}
          </div>
        </div>

        {/* Info box */}
        <div className="bg-muted/50 rounded-lg p-4 text-sm text-muted-foreground">
          <p className="font-medium text-foreground mb-1">üí° Comment √ßa fonctionne</p>
          <ul className="list-disc list-inside space-y-1">
            <li>Les utilisateurs <strong>Direction</strong> voient toujours toutes les donn√©es</li>
            <li>Les utilisateurs <strong>Exploitation</strong> voient selon vos param√®tres ci-dessus</li>
            <li>Les utilisateurs <strong>Membre</strong> ne voient aucune donn√©e financi√®re</li>
          </ul>
        </div>
      </CardContent>
    </Card>
  );
}
